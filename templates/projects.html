<!-- templates/projects.html -->
{% extends "base.html" %}

{% block hero %}

<!-- Sticky Search and Filter Bar - Full Width -->
<div class="projects-filter-wrapper">
  <div class="projects-filter-bar">
    <div class="filter-search">
      <input type="text" id="searchInput" placeholder="Search projects..." oninput="filterAndSortProjects()">
    </div>
    <div class="filter-controls">
      <select id="sortBy" onchange="filterAndSortProjects()">
        <option value="name">Sort by Name</option>
        <option value="date">Sort by Date</option>
        <option value="budget">Sort by Budget</option>
        <option value="spent">Sort by Spent</option>
      </select>
      <select id="sortOrder" onchange="filterAndSortProjects()">
        <option value="asc">Ascending ↑</option>
        <option value="desc">Descending ↓</option>
      </select>
      <select id="statusFilter" onchange="filterAndSortProjects()">
        <option value="">All Status</option>
        <option value="Planned">Planned</option>
        <option value="Ongoing">Ongoing</option>
        <option value="Completed">Completed</option>
      </select>
      <select id="regionFilter" onchange="filterAndSortProjects()">
        <option value="">All Regions</option>
        {% for region in regions_list %}
        <option value="{{ region|lower }}">{{ region }}</option>
        {% endfor %}
      </select>
      <select id="sectorFilter" onchange="filterAndSortProjects()">
        <option value="">All Sectors</option>
        {% for sector in sectors_list %}
        <option value="{{ sector|lower }}">{{ sector }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>

<!-- Projects Hero Section -->
<section class="projects-hero">
  <div class="projects-hero-content">
    <h1>Government Projects</h1>
    <p>A collection of government-led projects designed to enhance connectivity, support local communities, and drive national progress.</p>
    <div class="projects-hero-stats">
      <div class="hero-stat">
        <div class="hero-stat-value">{{ total_count }}</div>
        <div class="hero-stat-label">Total Projects</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-value">{{ planned_count }}</div>
        <div class="hero-stat-label">Planned</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-value">{{ ongoing_count }}</div>
        <div class="hero-stat-label">Ongoing</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-value">{{ completed_count }}</div>
        <div class="hero-stat-label">Completed</div>
      </div>
    </div>
  </div>
</section>


{% endblock %}

{% block content %}
<div>
  <h2>Projects:</h2>
</div>
<div class="projects-grid" id="projectsGrid">
  {% for p in projects %}
  <div class="project-card" style="position: relative;"
       data-name="{{ p.project_name|lower }}"
       data-date="{{ p.start_date or '' }}"
       data-budget="{{ p.allocated_budget or 0 }}"
       data-spent="{{ p.budget_spent or 0 }}"
       data-status="{{ p.project_status|lower }}"
       data-region="{{ (p.region_name or '')|lower }}"
       data-sector="{{ (p.sector_name or '')|lower }}">
    {% if session.get('admin_user') %}
    <button class="edit-btn" data-project-id="{{ p.project_id }}">✎ Edit</button>
    {% endif %}
    <a href="{{ url_for('project_detail', pid=p.project_id) }}" class="project-card-image">
      {% if p.project_image %}
      <img src="{{ url_for('static', filename=p.project_image) }}" alt="{{ p.project_name }}">
      {% else %}
      <img src="{{ url_for('static', filename='images/' + (p.sector_name or 'Road Infrastructure') + '.webp') }}" alt="{{ p.sector_name or 'Project' }}">
      {% endif %}
    </a>
    <div class="project-card-content">
      <h3><a href="{{ url_for('project_detail', pid=p.project_id) }}">{{ p.project_name }}</a></h3>
      <p class="muted">{{ p.sector_name or 'N/A' }} — {{ p.region_name or 'N/A' }}</p>
      <p class="project-desc">{{ p.project_description or '-' }}</p>
      <div class="project-meta">
        <div>Allocated: ₱{{ "{:,.2f}".format(p.allocated_budget or 0) }}</div>
        <div>Spent: ₱{{ "{:,.2f}".format(p.budget_spent or 0) }}</div>
        <div>Status: <strong>{{ p.project_status }}</strong></div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<p id="noResults" style="display: none; text-align: center; padding: 2rem; color: #666;">No projects found matching your criteria.</p>

<!-- Edit Project Modal -->
<div id="editModal" class="edit-modal-overlay" style="display: none;" onclick="closeEditModal(event)">
  <div class="edit-modal" onclick="event.stopPropagation()">
    <div class="edit-modal-header">
      <h2>Edit Project</h2>
      <button class="edit-modal-close" onclick="closeEditModal()">&times;</button>
    </div>
    <div class="edit-modal-body">
      <form id="editProjectForm" method="post" enctype="multipart/form-data">
        <div class="form-row">
          <div>
            <label>Project Name</label>
            <input name="name" type="text" required>
          </div>
          <div>
            <label>Project Sector</label>
            <select name="project_sector" required>
              <option value="">Select Project Sector</option>
              <option value="Road Infrastructure">Road Infrastructure</option>
              <option value="Bridge Infrastructure">Bridge Infrastructure</option>
              <option value="Flood Control and Drainage">Flood Control and Drainage</option>
              <option value="Public Buildings">Public Buildings</option>
              <option value="Water Resources and Irrigation">Water Resources and Irrigation</option>
              <option value="Special Infrastructure Projects">Special Infrastructure Projects</option>
              <option value="Disaster Response and Rehabilitation">Disaster Response and Rehabilitation</option>
              <option value="Local Infrastructure Support">Local Infrastructure Support</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Region</label>
            <select name="region" id="regionSelect" required>
              <option value="">Select Region</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select name="status">
              <option value="Planned">Planned</option>
              <option value="Ongoing">Ongoing</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Allocated Budget</label>
            <input name="allocated_budget" type="number" step="0.01" required>
          </div>
          <div>
            <label>Spent Amount</label>
            <input name="spent" type="number" step="0.01" required>
          </div>
        </div>

        <div style="margin-bottom: 0.6rem;">
          <label style="display: block; font-weight: 600; font-size: 0.95rem; color: #333; margin-bottom: 0.4rem;">Project Image</label>
          <div class="file-upload-wrapper">
            <input type="file" name="project_image" id="editProjectImageInput" accept="image/*" class="file-input-hidden">
            <div id="currentImagePreview" class="file-preview" style="display: none;">
              <img id="editImagePreview" src="" alt="Current image">
              <span class="file-name" id="editFileName">Current image</span>
              <button type="button" class="file-remove-btn" onclick="clearEditFileInput()">✕</button>
            </div>
            <label for="editProjectImageInput" class="file-upload-label" id="editUploadLabel">
              <span class="file-upload-text">Click to upload new image</span>
            </label>
          </div>
        </div>

        <div style="margin-bottom: 0.6rem;">
          <label style="display: block; font-weight: 600; font-size: 0.95rem; color: #333; margin-bottom: 0.4rem;">Description</label>
          <textarea name="description" rows="4" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-family: 'Inter', sans-serif; resize: vertical;"></textarea>
        </div>

        <div class="form-row" style="gap: 1rem; justify-content: space-between;">
          <button class="btn" type="submit">Save Changes</button>
          <button type="button" class="btn btn-danger" onclick="deleteProject()">Delete Project</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='projects.js') }}"></script>
<script>
  // Initialize with regions data from server
  document.addEventListener('DOMContentLoaded', function() {
    const regions = JSON.parse('{{ regions_list|tojson|safe }}');
    initProjectsPage(regions);
  });
</script>
{% endblock %}
