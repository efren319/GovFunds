<!-- templates/project_detail.html -->
{% extends "base.html" %} {% block hero %}
<div class="project-hero">
  <div class="project-hero-image">
    {% if project.project_image %}
    <img
      src="{{ url_for('static', filename=project.project_image) }}"
      alt="{{ project.project_name }}"
    />
    {% else %}
    <img
      src="{{ url_for('static', filename='images/' + (project.sector_name or 'Road Infrastructure') + '.webp') }}"
      alt="{{ project.sector_name or 'Project' }}"
    />
    {% endif %}
  </div>
  <div class="project-hero-overlay">
    <div class="project-hero-content">
      <h1>{{ project.project_name }}</h1>
      <p class="project-hero-meta">
        {{ project.sector_name or 'N/A' }} — {{ project.region_name or 'N/A' }}
      </p>
      <p class="project-hero-description">{{ project.project_description }}</p>
    </div>
  </div>
</div>
{% endblock %} {% block content %}

<ul class="detail-list">
  <li>
    Allocated Budget: ₱{{ "{:,.2f}".format(project.allocated_budget or 0) }}
  </li>
  <li>Spent: ₱{{ "{:,.2f}".format(project.budget_spent or 0) }}</li>
  <li>
    Remaining: ₱{{ "{:,.2f}".format((project.allocated_budget or 0) -
    (project.budget_spent or 0)) }}
  </li>
  <li>Status: {{ project.project_status }}</li>
  <li>Start: {{ project.start_date or 'N/A' }}</li>
  <li>End: {{ project.end_date or 'N/A' }}</li>
</ul>

<!-- Report Form and Reports Container -->
<div class="report-container">
  <!-- Report Submission Form -->
  <div class="report-form-section">
    <h3>Submit a Report</h3>
    <p class="form-description">
      Have feedback or found an issue with this project? Let us know.
    </p>
    <form
      method="post"
      action="{{ url_for('feedback') }}"
      class="form report-form"
      enctype="multipart/form-data"
    >
      <input type="hidden" name="feedback_type" value="report" />
      <input type="hidden" name="project_id" value="{{ project.project_id }}" />

      <div class="form-row">
        <input
          type="text"
          name="reporter_name"
          placeholder="Your name (optional)"
        />
        <input
          type="email"
          name="reporter_email"
          placeholder="Your email (optional)"
        />
      </div>

      <div class="form-row">
        <input
          type="text"
          name="report_subject"
          placeholder="Report subject"
          required
        />
        <select name="report_type" required>
          <option value="">Select report type</option>
          <option value="General">General Feedback</option>
          <option value="Issue">Issue/Problem</option>
          <option value="Concern">Concern</option>
          <option value="Suggestion">Suggestion</option>
        </select>
      </div>

      <div class="form-row">
        <textarea
          name="report_message"
          placeholder="Describe your report..."
          required
        ></textarea>
      </div>

      <div class="form-row">
        <div style="flex: 1">
          <label style="display: block; font-weight: 600; margin-bottom: 0.4rem"
            >Report Image (Optional)</label
          >
          <div class="file-upload-wrapper">
            <input
              type="file"
              name="report_image"
              id="projectReportImageInput"
              accept="image/*"
              class="file-input-hidden"
            />
            <label for="projectReportImageInput" class="file-upload-label">
              <span class="file-upload-text">Click to upload image</span>
            </label>
            <div
              class="file-preview"
              id="projectReportFilePreview"
              style="display: none"
            >
              <img id="projectReportPreviewImage" src="" alt="Preview" />
              <span class="file-name" id="projectReportFileName"></span>
              <button
                type="button"
                class="file-remove-btn"
                onclick="clearProjectReportFileInput()"
              >
                ✕
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="form-row">
        <button type="submit" class="btn">Submit Report</button>
      </div>
    </form>
  </div>

  <!-- Reports Section -->
  {% if reports %}
  <div class="reports-section-container">
    <h3>Project Reports ({{ reports|length }})</h3>
    <div class="reports-section">
      {% for report in reports %}
      <div
        class="report-card {% if not report.is_resolved %}unresolved{% endif %}"
      >
        <div class="report-header">
          <div>
            <h4>{{ report.report_subject }}</h4>
            <span
              class="report-type report-type-{{ (report.report_type or 'general')|lower }}"
              >{{ report.report_type or 'General' }}</span
            >
          </div>
          {% if not report.is_resolved %}
          <span class="unresolved-badge">UNRESOLVED</span>
          {% else %}
          <span class="resolved-badge">RESOLVED</span>
          {% endif %}
        </div>
        {% if report.report_image %}
        <div class="report-image">
          <img
            src="{{ url_for('static', filename='images/projects/' + report.report_image) }}"
            alt="Report image"
          />
        </div>
        {% endif %}
        <p class="report-message">{{ report.report_message }}</p>
        <div class="report-meta">
          <span class="report-reporter"
            >{{ report.reporter_name or 'Anonymous' }}</span
          >
          <span class="report-date"
            >{{ report.created_at.strftime('%Y-%m-%d %H:%M') if
            report.created_at else '' }}</span
          >
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<script>
  // File upload preview functionality
  document
    .getElementById("projectReportImageInput")
    .addEventListener("change", function (e) {
      const file = e.target.files[0];
      const preview = document.getElementById("projectReportFilePreview");
      const previewImage = document.getElementById("projectReportPreviewImage");
      const fileName = document.getElementById("projectReportFileName");
      const uploadLabel = document.querySelector(
        '[for="projectReportImageInput"].file-upload-label'
      );

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImage.src = e.target.result;
          fileName.textContent = file.name;
          preview.style.display = "flex";
          uploadLabel.style.display = "none";
        };
        reader.readAsDataURL(file);
      }
    });

  function clearProjectReportFileInput() {
    const input = document.getElementById("projectReportImageInput");
    const preview = document.getElementById("projectReportFilePreview");
    const uploadLabel = document.querySelector(
      '[for="projectReportImageInput"].file-upload-label'
    );

    input.value = "";
    preview.style.display = "none";
    uploadLabel.style.display = "flex";
  }
</script>

{% endblock %}
