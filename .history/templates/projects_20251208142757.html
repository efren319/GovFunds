<!-- templates/projects.html -->
{% extends "base.html" %}
{% block content %}
<h2>Projects</h2>
<p>List of government projects being tracked.</p>

<div class="projects-grid">
  {% for p in projects %}
  <div class="project-card" style="position: relative;">
    {% if session.get('admin_user') %}
    <button class="edit-btn" data-project-id="{{ p.id }}">✎ Edit</button>
    {% endif %}
    <h3><a href="{{ url_for('project_detail', pid=p.id) }}">{{ p.name }}</a></h3>
    <p class="muted">{{ p.project_sector }} — {{ p.region or 'N/A' }}</p>
    <p>{{ p.description or '-' }}</p>
    <div class="project-meta">
      <div>Allocated: ₱{{ "{:,.2f}".format(p.allocated_budget or 0) }}</div>
      <div>Spent: ₱{{ "{:,.2f}".format(p.spent or 0) }}</div>
      <div>Status: <strong>{{ p.status }}</strong></div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Edit Project Modal -->
<div id="editModal" class="edit-modal-overlay" style="display: none;" onclick="closeEditModal(event)">
  <div class="edit-modal" onclick="event.stopPropagation()">
    <div class="edit-modal-header">
      <h2>Edit Project</h2>
      <button class="edit-modal-close" onclick="closeEditModal()">&times;</button>
    </div>
    <div class="edit-modal-body">
      <form id="editProjectForm" method="post">
        <div class="form-row">
          <div>
            <label>Project Name</label>
            <input name="name" type="text" required>
          </div>
          <div>
            <label>Project Sector</label>
            <select name="project_sector" required>
              <option value="">Select Project Sector</option>
              <option value="Road Infrastructure">Road Infrastructure</option>
              <option value="Bridge Infrastructure">Bridge Infrastructure</option>
              <option value="Flood Control and Drainage">Flood Control and Drainage</option>
              <option value="Public Buildings">Public Buildings</option>
              <option value="Water Resources and Irrigation">Water Resources and Irrigation</option>
              <option value="Special Infrastructure Projects">Special Infrastructure Projects</option>
              <option value="Disaster Response and Rehabilitation">Disaster Response and Rehabilitation</option>
              <option value="Local Infrastructure Support">Local Infrastructure Support</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Region</label>
            <select name="region" id="regionSelect" required>
              <option value="">Select Region</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select name="status">
              <option value="Planned">Planned</option>
              <option value="Ongoing">Ongoing</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Allocated Budget</label>
            <input name="allocated_budget" type="number" step="0.01" required>
          </div>
          <div>
            <label>Spent Amount</label>
            <input name="spent" type="number" step="0.01" required>
          </div>
        </div>

        <div style="margin-bottom: 0.6rem;">
          <label style="display: block; font-weight: 600; font-size: 0.95rem; color: #333; margin-bottom: 0.4rem;">Description</label>
          <textarea name="description" rows="4" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-family: 'Inter', sans-serif; resize: vertical;"></textarea>
        </div>

        <div class="form-row" style="gap: 1rem; grid-template-columns: 1fr 1fr;">
          <button class="btn" type="submit">Save Changes</button>
          <button class="btn" type="button" onclick="closeEditModal()" style="background: #666; color: #fff;">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let currentProjectId = null;
  const allRegions = JSON.parse('{{ regions_list|tojson|safe }}');

  async function openEditModal(projectId) {
    currentProjectId = projectId;
    try {
      const response = await fetch(`/api/project/${projectId}`);
      const project = await response.json();
      
      // Populate form with project data
      document.querySelector('input[name="name"]').value = project.name;
      document.querySelector('select[name="project_sector"]').value = project.project_sector;
      document.querySelector('select[name="region"]').value = project.region;
      document.querySelector('select[name="status"]').value = project.status;
      document.querySelector('input[name="allocated_budget"]').value = project.allocated_budget;
      document.querySelector('input[name="spent"]').value = project.spent;
      document.querySelector('textarea[name="description"]').value = project.description || '';
      
      // Populate regions
      populateRegions();
      
      // Show modal
      document.getElementById('editModal').style.display = 'flex';
    } catch (error) {
      console.error('Error loading project:', error);
      alert('Error loading project data');
    }
  }

  function closeEditModal(event) {
    if (event && event.target !== document.getElementById('editModal')) return;
    document.getElementById('editModal').style.display = 'none';
    currentProjectId = null;
  }

  function populateRegions() {
    const select = document.getElementById('regionSelect');
    const currentValue = select.value;
    
    // Clear existing options (except the first one)
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    // Add all regions
    allRegions.forEach(region => {
      const option = document.createElement('option');
      option.value = region;
      option.textContent = region;
      select.appendChild(option);
    });
    
    select.value = currentValue;
  }

  document.getElementById('editProjectForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(document.getElementById('editProjectForm'));
    
    try {
      const response = await fetch(`/project/${currentProjectId}/edit`, {
        method: 'POST',
        body: formData
      });
      
      if (response.ok) {
        location.reload();
      } else {
        alert('Error updating project');
      }
    } catch (error) {
      console.error('Error updating project:', error);
      alert('Error updating project');
    }
  });

  // Close modal when clicking outside
  document.getElementById('editModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      closeEditModal();
    }
  });
</script>
{% endblock %}
